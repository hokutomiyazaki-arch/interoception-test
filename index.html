<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="application-name" content="å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ">
    <meta name="apple-mobile-web-app-title" content="å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ">
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" href="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512.png">
    <link rel="apple-touch-icon" href="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512.png">
    
    <meta name="theme-color" content="#e74c3c">
    
    <title>å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            display: flex;
            flex-direction: column;
        }

        /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .splash-screen.hide {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
        }

        .splash-brand {
            font-size: 1rem;
            color: #333;
            margin-bottom: 8px;
        }

        .splash-title {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .splash-copyright {
            font-size: 0.7rem;
            color: #888;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            padding-top: calc(10px + env(safe-area-inset-top));
            background: rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            height: 32px;
            width: auto;
        }

        .header h1 {
            font-size: 1rem;
            background: linear-gradient(135deg, #e74c3c 0%, #f39c12 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 15px;
            padding-top: 10px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ã‚¹ãƒ†ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .step-content {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .step-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .step-dot.active {
            background: #e74c3c;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.5);
        }

        .step-dot.completed {
            background: #2ecc71;
        }

        .step-line {
            width: 15px;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* æŒ‡ç¤ºãƒœãƒƒã‚¯ã‚¹ */
        .instruction-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 15px;
            text-align: center;
            width: 100%;
        }

        .instruction-step {
            font-size: 0.75rem;
            color: #f39c12;
            margin-bottom: 6px;
        }

        .instruction-text {
            font-size: 1rem;
            color: #fff;
            line-height: 1.5;
        }

        /* ã‚«ãƒ¡ãƒ©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .camera-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 12px;
        }

        .camera-container {
            position: relative;
            width: 130px;
            height: 130px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #444;
            background: #000;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .camera-container.detecting {
            border-color: #2ecc71;
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.5);
        }

        .camera-container.error {
            border-color: #e74c3c;
        }

        .camera-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-label {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #aaa;
        }

        .camera-name {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
        }

        .btn-camera-switch {
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 0.85rem;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            display: none;
        }

        .btn-camera-switch:active {
            background: rgba(255, 255, 255, 0.25);
        }

        /* å¿ƒæ‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .heartbeat-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .heart-icon {
            font-size: 2rem;
            transition: transform 0.1s;
        }

        .heart-icon.beat {
            transform: scale(1.3);
        }

        .bpm-display {
            text-align: center;
        }

        .bpm-value {
            font-size: 2rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .bpm-label {
            font-size: 0.7rem;
            color: #888;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼ */
        .timer-section {
            text-align: center;
            margin-bottom: 15px;
        }

        .timer-value {
            font-size: 4.5rem;
            font-weight: bold;
            color: #3498db;
            text-shadow: 0 0 25px rgba(52, 152, 219, 0.5);
            line-height: 1;
        }

        .timer-label {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 14px 35px;
            font-size: 1rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, opacity 0.2s;
            margin-top: 10px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        /* å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .input-section {
            width: 100%;
            max-width: 280px;
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 8px;
            text-align: center;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            font-size: 1.8rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #3498db;
            border-radius: 12px;
            color: white;
            outline: none;
        }

        .input-field:focus {
            border-color: #e74c3c;
        }

        /* çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .result-section {
            width: 100%;
            max-width: 350px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            text-align: center;
        }

        .result-card h3 {
            font-size: 0.9rem;
            color: #f39c12;
            margin-bottom: 8px;
        }

        .result-rank {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .rank-S { color: #f1c40f; }
        .rank-A { color: #2ecc71; }
        .rank-B { color: #3498db; }
        .rank-C { color: #9b59b6; }
        .rank-D { color: #e74c3c; }

        .result-description {
            font-size: 0.95rem;
            color: #ccc;
        }

        .result-detail {
            display: flex;
            justify-content: space-around;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-item {
            text-align: center;
        }

        .detail-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #fff;
        }

        .detail-label {
            font-size: 0.65rem;
            color: #888;
        }

        .error-value {
            color: #e74c3c;
        }

        /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ */
        .camera-error {
            text-align: center;
            padding: 20px;
        }

        .error-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
        }

        .error-title {
            font-size: 1.1rem;
            color: #e74c3c;
            margin-bottom: 8px;
        }

        .error-message {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .side-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 290px;
            max-width: 85vw;
            height: 100%;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
        }

        .side-menu.open {
            right: 0;
        }

        .side-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            padding-top: calc(12px + env(safe-area-inset-top));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .side-menu-header h2 {
            font-size: 1rem;
            color: #e74c3c;
        }

        .close-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
        }

        .side-menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            -webkit-overflow-scrolling: touch;
            touch-action: auto !important;
        }

        .side-menu-content * {
            touch-action: auto !important;
        }

        .menu-section {
            margin-bottom: 15px;
        }

        .menu-section h3 {
            color: #f39c12;
            font-size: 0.85rem;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-section p {
            color: #ccc;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .setting-item {
            margin-bottom: 10px;
        }

        .setting-item label {
            display: block;
            color: #aaa;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .setting-item select {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .menu-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer {
            text-align: center;
            padding: 6px;
            padding-bottom: calc(6px + env(safe-area-inset-bottom));
            font-size: 0.65rem;
            color: #555;
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        /* éè¡¨ç¤º */
        .hidden {
            display: none !important;
        }

        #hiddenCanvas {
            display: none;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
        .main-area::-webkit-scrollbar {
            display: none;
        }

        .main-area {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* å°ã•ã„ç”»é¢ç”¨èª¿æ•´ */
        @media (max-height: 650px) {
            .camera-container {
                width: 110px;
                height: 110px;
            }
            .timer-value {
                font-size: 3.5rem;
            }
            .result-rank {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
    <div class="splash-screen" id="splashScreen">
        <img src="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512.png" alt="FNT Logo" class="splash-logo">
        <div class="splash-brand">Functional Neuro Training</div>
        <div class="splash-title">å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ</div>
        <div class="splash-copyright">Â© 2025 Functional Neuro Training</div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="main-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <div class="header-left">
                <img src="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512-transparent.png" alt="FNT" class="logo">
                <h1>å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ</h1>
            </div>
            <button class="menu-btn" id="menuBtn">â˜°</button>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
        <main class="main-area" id="mainArea">
            <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ã‚«ãƒ¡ãƒ©æº–å‚™ -->
            <div id="step1" class="step-content">
                <div class="step-indicator">
                    <div class="step-dot active"></div>
                    <div class="step-line"></div>
                    <div class="step-dot"></div>
                    <div class="step-line"></div>
                    <div class="step-dot"></div>
                    <div class="step-line"></div>
                    <div class="step-dot"></div>
                </div>

                <div class="instruction-box">
                    <div class="instruction-step">ã‚¹ãƒ†ãƒƒãƒ— 1/4</div>
                    <div class="instruction-text">
                        ã‚«ãƒ¡ãƒ©ã®æ¨ªã«ã‚ã‚‹ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒˆã«<br>æŒ‡å…ˆã‚’ã—ã£ã‹ã‚ŠæŠ¼ã—å½“ã¦ã¦ãã ã•ã„
                    </div>
                </div>

                <div class="camera-section">
                    <div class="camera-container" id="cameraContainer">
                        <video id="cameraVideo" autoplay playsinline muted></video>
                    </div>
                    <div class="camera-label" id="cameraLabel">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...</div>
                    <div class="camera-name" id="cameraName"></div>
                    <button class="btn-camera-switch" id="switchCameraBtn">ğŸ“· ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
                </div>

                <div class="heartbeat-indicator">
                    <span class="heart-icon" id="heartIcon">â¤ï¸</span>
                    <div class="bpm-display">
                        <div class="bpm-value" id="bpmValue">--</div>
                        <div class="bpm-label">BPM</div>
                    </div>
                </div>

                <button class="btn btn-primary" id="readyBtn" disabled>å¿ƒæ‹ã‚’æ¤œå‡ºã—ãŸã‚‰æŠ¼ã™</button>
            </div>

            <!-- ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ -->
            <div id="cameraError" class="step-content hidden">
                <div class="camera-error">
                    <div class="error-icon">ğŸ“·</div>
                    <div class="error-title">ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</div>
                    <div class="error-message">
                        ã“ã®ã‚¢ãƒ—ãƒªã¯å¿ƒæ‹æ¸¬å®šã®ãŸã‚ã«ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
                        ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚
                    </div>
                    <button class="btn btn-warning" id="retryCamera">ã‚«ãƒ¡ãƒ©ã‚’å†èµ·å‹•</button>
                    <div style="margin-top: 12px;">
                        <button class="btn btn-secondary" id="openSettings">è¨­å®šæ–¹æ³•ã‚’è¦‹ã‚‹</button>
                    </div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—2: æ¸¬å®šä¸­ -->
            <div id="step2" class="step-content hidden">
                <div class="step-indicator">
                    <div class="step-dot completed"></div>
                    <div class="step-line"></div>
                    <div class="step-dot active"></div>
                    <div class="step-line"></div>
                    <div class="step-dot"></div>
                    <div class="step-line"></div>
                    <div class="step-dot"></div>
                </div>

                <div class="instruction-box">
                    <div class="instruction-step">ã‚¹ãƒ†ãƒƒãƒ— 2/4</div>
                    <div class="instruction-text">
                        è‡ªåˆ†ã®å¿ƒæ‹ã‚’æ„Ÿã˜ãªãŒã‚‰<br>é™ã‹ã«æ•°ãˆã¦ãã ã•ã„
                    </div>
                </div>

                <div class="timer-section">
                    <div class="timer-value" id="timerValue">30</div>
                    <div class="timer-label">æ®‹ã‚Šæ™‚é–“ï¼ˆç§’ï¼‰</div>
                </div>

                <div class="heartbeat-indicator">
                    <span class="heart-icon" id="heartIcon2">â¤ï¸</span>
                    <div class="bpm-display">
                        <div class="bpm-value" id="bpmValue2">--</div>
                        <div class="bpm-label">æ¤œå‡ºä¸­</div>
                    </div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—3: å…¥åŠ› -->
            <div id="step3" class="step-content hidden">
                <div class="step-indicator">
                    <div class="step-dot completed"></div>
                    <div class="step-line"></div>
                    <div class="step-dot completed"></div>
                    <div class="step-line"></div>
                    <div class="step-dot active"></div>
                    <div class="step-line"></div>
                    <div class="step-dot"></div>
                </div>

                <div class="instruction-box">
                    <div class="instruction-step">ã‚¹ãƒ†ãƒƒãƒ— 3/4</div>
                    <div class="instruction-text">
                        ã‚ãªãŸãŒæ•°ãˆãŸå¿ƒæ‹ã®å›æ•°ã‚’<br>å…¥åŠ›ã—ã¦ãã ã•ã„
                    </div>
                </div>

                <div class="input-section">
                    <label class="input-label">æ„Ÿã˜ãŸå¿ƒæ‹æ•°</label>
                    <input type="number" class="input-field" id="perceivedInput" min="0" max="200" placeholder="0" inputmode="numeric">
                </div>

                <button class="btn btn-success" id="submitBtn">çµæœã‚’è¦‹ã‚‹</button>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—4: çµæœ -->
            <div id="step4" class="step-content hidden">
                <div class="step-indicator">
                    <div class="step-dot completed"></div>
                    <div class="step-line"></div>
                    <div class="step-dot completed"></div>
                    <div class="step-line"></div>
                    <div class="step-dot completed"></div>
                    <div class="step-line"></div>
                    <div class="step-dot active"></div>
                </div>

                <div class="result-section">
                    <div class="result-card">
                        <h3>ã‚ãªãŸã®å†…å—å®¹è¦šãƒ©ãƒ³ã‚¯</h3>
                        <div class="result-rank" id="resultRank">-</div>
                        <div class="result-description" id="resultDesc">-</div>
                        <div class="result-detail">
                            <div class="detail-item">
                                <div class="detail-value" id="actualCount">-</div>
                                <div class="detail-label">å®Ÿæ¸¬å¿ƒæ‹</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value" id="perceivedCount">-</div>
                                <div class="detail-label">ç”³å‘Šå¿ƒæ‹</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value error-value" id="errorCount">-</div>
                                <div class="detail-label">èª¤å·®</div>
                            </div>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>ç²¾åº¦ã‚¹ã‚³ã‚¢ (IAc)</h3>
                        <div class="detail-value" id="iacScore" style="font-size: 1.8rem; color: #3498db;">-</div>
                        <p style="font-size: 0.7rem; color: #888; margin-top: 8px;">
                            Schandryæ³•ã«ã‚ˆã‚‹å¿ƒæ‹çŸ¥è¦šç²¾åº¦ï¼ˆ1.00ã«è¿‘ã„ã»ã©æ­£ç¢ºï¼‰
                        </p>
                    </div>

                    <button class="btn btn-primary" id="retryBtn">ã‚‚ã†ä¸€åº¦æ¸¬å®šã™ã‚‹</button>
                </div>
            </div>
        </main>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="footer">
            Â© 2025 Functional Neuro Training. All rights reserved.
        </footer>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h2>è¨­å®šãƒ»æƒ…å ±</h2>
            <button class="close-menu-btn" id="closeMenuBtn">âœ•</button>
        </div>
        <div class="side-menu-content">
            <div class="menu-section">
                <h3>ğŸ§  å†…å—å®¹è¦šã¨ã¯</h3>
                <p>
                    å†…å—å®¹è¦šï¼ˆInteroceptionï¼‰ã¯ã€å¿ƒæ‹ãƒ»å‘¼å¸ãƒ»ç©ºè…¹æ„Ÿãªã©ä½“å†…ã®çŠ¶æ…‹ã‚’æ„ŸçŸ¥ã™ã‚‹èƒ½åŠ›ã§ã™ã€‚
                    å³¶çš®è³ªãŒä¸­å¿ƒçš„å½¹å‰²ã‚’æ‹…ã„ã€æ„Ÿæƒ…èªè­˜ã‚„æ„æ€æ±ºå®šã«ã‚‚é–¢ä¸ã—ã¦ã„ã¾ã™ã€‚
                </p>
            </div>

            <div class="menu-section">
                <h3>ğŸ“Š ãƒ©ãƒ³ã‚¯ã®ç›®å®‰</h3>
                <p>
                    <strong style="color: #f1c40f;">S:</strong> èª¤å·®0-2å› - æ¥µã‚ã¦å„ªç§€<br>
                    <strong style="color: #2ecc71;">A:</strong> èª¤å·®3-5å› - å„ªç§€<br>
                    <strong style="color: #3498db;">B:</strong> èª¤å·®6-10å› - è‰¯å¥½<br>
                    <strong style="color: #9b59b6;">C:</strong> èª¤å·®11-15å› - å¹³å‡çš„<br>
                    <strong style="color: #e74c3c;">D:</strong> èª¤å·®16å›ä»¥ä¸Š - è¦ç·´ç¿’
                </p>
            </div>

            <div class="menu-section">
                <h3>âš™ï¸ è¨­å®š</h3>
                <div class="setting-item">
                    <label>æ¸¬å®šæ™‚é–“</label>
                    <select id="durationSelect">
                        <option value="25">25ç§’</option>
                        <option value="30" selected>30ç§’</option>
                        <option value="45">45ç§’</option>
                        <option value="60">60ç§’</option>
                    </select>
                </div>
            </div>

            <div class="menu-section">
                <h3>ğŸ“š å‚è€ƒæ–‡çŒ®</h3>
                <p style="font-size: 0.7rem;">
                    Schandry R. (1981). Heart beat perception and emotional experience. Psychophysiology, 18(4), 483-488.
                </p>
            </div>
        </div>
    </div>

    <!-- éš ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <canvas id="hiddenCanvas" width="100" height="100"></canvas>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let audioContext = null;
        let videoStream = null;
        let isDetecting = false;
        let measurementDuration = 30;
        let measurementTimer = null;
        let animationFrame = null;

        // ã‚«ãƒ¡ãƒ©é–¢é€£
        let availableCameras = [];
        let backCameras = [];
        let currentCameraIndex = 0;

        // PPGè§£æç”¨
        let ppgData = [];
        let baseline = 0;
        let threshold = 0;
        let peakDetected = false;
        let lastPeakTime = 0;
        let beatCount = 0;
        let recentBPMs = [];
        let currentBPM = 0;
        let stableDetectionCount = 0;

        // DOMè¦ç´ 
        const elements = {};

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // DOMè¦ç´ å–å¾—
            elements.splashScreen = document.getElementById('splashScreen');
            elements.menuBtn = document.getElementById('menuBtn');
            elements.sideMenu = document.getElementById('sideMenu');
            elements.menuOverlay = document.getElementById('menuOverlay');
            elements.closeMenuBtn = document.getElementById('closeMenuBtn');
            
            elements.step1 = document.getElementById('step1');
            elements.step2 = document.getElementById('step2');
            elements.step3 = document.getElementById('step3');
            elements.step4 = document.getElementById('step4');
            elements.cameraError = document.getElementById('cameraError');
            
            elements.cameraVideo = document.getElementById('cameraVideo');
            elements.cameraContainer = document.getElementById('cameraContainer');
            elements.cameraLabel = document.getElementById('cameraLabel');
            elements.cameraName = document.getElementById('cameraName');
            elements.heartIcon = document.getElementById('heartIcon');
            elements.bpmValue = document.getElementById('bpmValue');
            
            elements.readyBtn = document.getElementById('readyBtn');
            elements.retryCamera = document.getElementById('retryCamera');
            elements.openSettings = document.getElementById('openSettings');
            elements.switchCameraBtn = document.getElementById('switchCameraBtn');
            
            elements.timerValue = document.getElementById('timerValue');
            elements.heartIcon2 = document.getElementById('heartIcon2');
            elements.bpmValue2 = document.getElementById('bpmValue2');
            
            elements.perceivedInput = document.getElementById('perceivedInput');
            elements.submitBtn = document.getElementById('submitBtn');
            
            elements.resultRank = document.getElementById('resultRank');
            elements.resultDesc = document.getElementById('resultDesc');
            elements.actualCount = document.getElementById('actualCount');
            elements.perceivedCount = document.getElementById('perceivedCount');
            elements.errorCount = document.getElementById('errorCount');
            elements.iacScore = document.getElementById('iacScore');
            elements.retryBtn = document.getElementById('retryBtn');
            
            elements.durationSelect = document.getElementById('durationSelect');
            elements.hiddenCanvas = document.getElementById('hiddenCanvas');

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            elements.menuBtn.addEventListener('click', openMenu);
            elements.closeMenuBtn.addEventListener('click', closeMenu);
            elements.menuOverlay.addEventListener('click', closeMenu);
            
            elements.readyBtn.addEventListener('click', startMeasurement);
            elements.retryCamera.addEventListener('click', initCamera);
            elements.openSettings.addEventListener('click', showSettingsHelp);
            elements.switchCameraBtn.addEventListener('click', switchCamera);
            elements.submitBtn.addEventListener('click', showResults);
            elements.retryBtn.addEventListener('click', resetTest);
            
            elements.durationSelect.addEventListener('change', (e) => {
                measurementDuration = parseInt(e.target.value);
            });

            // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥å¾Œã«è‡ªå‹•ã§ã‚«ãƒ¡ãƒ©èµ·å‹•
            setTimeout(() => {
                elements.splashScreen.classList.add('hide');
                setTimeout(initCamera, 500);
            }, 2000);

            // AudioContextåˆæœŸåŒ–
            document.addEventListener('click', initAudio, { once: true });
            document.addEventListener('touchstart', initAudio, { once: true });
        });

        // AudioContextåˆæœŸåŒ–
        async function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
            }
        }

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        function openMenu() {
            elements.sideMenu.classList.add('open');
            elements.menuOverlay.classList.add('show');
        }

        function closeMenu() {
            elements.sideMenu.classList.remove('open');
            elements.menuOverlay.classList.remove('show');
        }

        // ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–
        async function initCamera() {
            showStep('step1');
            elements.cameraLabel.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...';
            elements.readyBtn.disabled = true;
            elements.cameraContainer.classList.remove('detecting');
            
            try {
                // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }

                // ã¾ãšè¨±å¯ã‚’å¾—ã‚‹ãŸã‚ã«ã‚·ãƒ³ãƒ—ãƒ«ã«èµ·å‹•
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: 'environment' } }
                });
                
                elements.cameraVideo.srcObject = videoStream;
                await elements.cameraVideo.play();

                // ã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆã‚’å–å¾—
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(d => d.kind === 'videoinput');
                
                // èƒŒé¢ã‚«ãƒ¡ãƒ©ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                backCameras = availableCameras.filter(d => {
                    const label = d.label.toLowerCase();
                    // ãƒ•ãƒ­ãƒ³ãƒˆã‚«ãƒ¡ãƒ©ã‚’é™¤å¤–
                    if (label.includes('front') || label.includes('å‰é¢') || label.includes('å†…å´')) {
                        return false;
                    }
                    return true;
                });
                
                console.log('All cameras:', availableCameras.map(d => d.label));
                console.log('Back cameras:', backCameras.map(d => d.label));

                // ç¾åœ¨ã®ã‚«ãƒ¡ãƒ©ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
                const currentTrack = videoStream.getVideoTracks()[0];
                const currentLabel = currentTrack.label;
                console.log('Current camera:', currentLabel);
                
                for (let i = 0; i < backCameras.length; i++) {
                    if (backCameras[i].label === currentLabel) {
                        currentCameraIndex = i;
                        break;
                    }
                }

                // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚ªãƒ³
                await enableTorch(currentTrack);

                // ã‚«ãƒ¡ãƒ©åã‚’è¡¨ç¤º
                elements.cameraName.textContent = 'ä½¿ç”¨ä¸­: ' + currentLabel;

                elements.cameraLabel.textContent = 'æŒ‡å…ˆã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã«æŠ¼ã—å½“ã¦ã¦ãã ã•ã„';
                
                // èƒŒé¢ã‚«ãƒ¡ãƒ©ãŒè¤‡æ•°ã‚ã‚Œã°åˆ‡æ›¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if (backCameras.length > 1) {
                    elements.switchCameraBtn.style.display = 'inline-block';
                } else {
                    elements.switchCameraBtn.style.display = 'none';
                }
                
                startPPGDetection();

            } catch (error) {
                console.error('Camera error:', error);
                showCameraError();
            }
        }

        // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚ªãƒ³
        async function enableTorch(track) {
            try {
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                if (capabilities.torch) {
                    await track.applyConstraints({ advanced: [{ torch: true }] });
                    console.log('Torch enabled');
                    return true;
                }
            } catch (e) {
                console.log('Torch not available:', e);
            }
            return false;
        }

        // ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©ã®ã¿ï¼‰
        async function switchCamera() {
            if (backCameras.length <= 1) return;
            
            // PPGæ¤œå‡ºã‚’åœæ­¢
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            
            // ç¾åœ¨ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            
            // æ¬¡ã®èƒŒé¢ã‚«ãƒ¡ãƒ©ã«åˆ‡æ›¿
            currentCameraIndex = (currentCameraIndex + 1) % backCameras.length;
            const nextCamera = backCameras[currentCameraIndex];
            
            elements.cameraLabel.textContent = 'ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ä¸­...';
            elements.cameraContainer.classList.remove('detecting');
            elements.readyBtn.disabled = true;
            stableDetectionCount = 0;
            ppgData = [];
            recentBPMs = [];
            baseline = 0;
            threshold = 0;
            elements.bpmValue.textContent = '--';
            
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: { exact: nextCamera.deviceId },
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                elements.cameraVideo.srcObject = videoStream;
                await elements.cameraVideo.play();
                
                console.log('Switched to:', nextCamera.label);
                
                // ã‚«ãƒ¡ãƒ©åã‚’è¡¨ç¤º
                elements.cameraName.textContent = 'ä½¿ç”¨ä¸­: ' + nextCamera.label;
                
                // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚ªãƒ³
                const track = videoStream.getVideoTracks()[0];
                await enableTorch(track);
                
                elements.cameraLabel.textContent = 'æŒ‡å…ˆã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã«æŠ¼ã—å½“ã¦ã¦ãã ã•ã„';
                startPPGDetection();
                
            } catch (error) {
                console.error('Switch camera error:', error);
                elements.cameraLabel.textContent = 'ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                initCamera();
            }
        }

        // ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showCameraError() {
            elements.step1.classList.add('hidden');
            elements.cameraError.classList.remove('hidden');
        }

        // è¨­å®šæ–¹æ³•ã‚’è¡¨ç¤º
        function showSettingsHelp() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let message = '';
            if (isIOS) {
                message = 'ã€iOSã®å ´åˆã€‘\nè¨­å®š > Safari > ã‚«ãƒ¡ãƒ© ã§ã€Œè¨±å¯ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\n\nãã®å¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
            } else if (isAndroid) {
                message = 'ã€Androidã®å ´åˆã€‘\nè¨­å®š > ã‚¢ãƒ—ãƒª > ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ—ãƒª > æ¨©é™ > ã‚«ãƒ¡ãƒ© ã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚\n\nã¾ãŸã¯ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼æ¨ªã®ğŸ”’ãƒãƒ¼ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã—ã€ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
            } else {
                message = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\n\nã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼æ¨ªã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã‚µã‚¤ãƒˆã®è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ã€‚';
            }
            
            alert(message);
        }

        // PPGæ¤œå‡ºï¼ˆæ”¹å–„ç‰ˆï¼‰
        function startPPGDetection() {
            const ctx = elements.hiddenCanvas.getContext('2d');
            ppgData = [];
            stableDetectionCount = 0;
            let smoothedData = [];
            let lastValues = [];
            let calibrated = false;
            let frameCount = 0;
            
            function analyze() {
                frameCount++;
                
                try {
                    ctx.drawImage(elements.cameraVideo, 0, 0, 100, 100);
                    const imageData = ctx.getImageData(20, 20, 60, 60);
                    const data = imageData.data;

                    // RGBå€¤ã‚’è¨ˆç®—
                    let redSum = 0, greenSum = 0, blueSum = 0;
                    const pixelCount = data.length / 4;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        redSum += data[i];
                        greenSum += data[i + 1];
                        blueSum += data[i + 2];
                    }
                    
                    const avgRed = redSum / pixelCount;
                    const avgGreen = greenSum / pixelCount;
                    const avgBlue = blueSum / pixelCount;
                    
                    // æŒ‡ãŒå½“ãŸã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆèµ¤ãŒå¼·ã„å ´åˆï¼‰
                    const brightness = (avgRed + avgGreen + avgBlue) / 3;
                    const isFingerPresent = avgRed > 100 && avgRed > avgGreen * 1.1;
                    
                    // ç§»å‹•å¹³å‡ã§ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
                    lastValues.push(avgRed);
                    if (lastValues.length > 5) lastValues.shift();
                    const smoothedRed = lastValues.reduce((a, b) => a + b, 0) / lastValues.length;
                    
                    ppgData.push(smoothedRed);
                    if (ppgData.length > 200) ppgData.shift();
                    
                    // ãƒ‡ãƒãƒƒã‚°ï¼ˆ10ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ï¼‰
                    if (frameCount % 30 === 0) {
                        console.log('PPG:', {
                            red: avgRed.toFixed(1),
                            green: avgGreen.toFixed(1),
                            finger: isFingerPresent,
                            baseline: baseline.toFixed(1),
                            threshold: threshold.toFixed(2)
                        });
                    }

                    // æŒ‡ãŒå½“ãŸã£ã¦ã„ãªã„å ´åˆ
                    if (!isFingerPresent && ppgData.length > 30) {
                        elements.cameraLabel.textContent = 'æŒ‡ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã«æŠ¼ã—å½“ã¦ã¦ãã ã•ã„';
                        calibrated = false;
                        baseline = 0;
                        threshold = 0;
                    }

                    // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    if (!calibrated && ppgData.length >= 60 && isFingerPresent) {
                        const recent = ppgData.slice(-60);
                        const sum = recent.reduce((a, b) => a + b, 0);
                        baseline = sum / recent.length;
                        
                        // å¤‰å‹•å¹…ã‚’è¨ˆç®—
                        const min = Math.min(...recent);
                        const max = Math.max(...recent);
                        const range = max - min;
                        
                        // é–¾å€¤ã¯å¤‰å‹•å¹…ã®30%ã«è¨­å®š
                        threshold = range * 0.3;
                        
                        // æœ€å°é–¾å€¤ã‚’è¨­å®š
                        if (threshold < 0.5) threshold = 0.5;
                        
                        calibrated = true;
                        console.log('Calibration done:', { baseline, threshold, range });
                        elements.cameraLabel.textContent = 'å¿ƒæ‹ã‚’æ¤œå‡ºä¸­...';
                    }

                    // ãƒ”ãƒ¼ã‚¯æ¤œå‡º
                    if (calibrated && isFingerPresent) {
                        detectPeakImproved(smoothedRed);
                    }

                } catch (e) {
                    console.error('PPG error:', e);
                }

                animationFrame = requestAnimationFrame(analyze);
            }

            analyze();
        }

        // æ”¹å–„ç‰ˆãƒ”ãƒ¼ã‚¯æ¤œå‡º
        function detectPeakImproved(value) {
            const now = Date.now();
            const diff = value - baseline;
            const minInterval = 400; // 150BPMä¸Šé™
            const maxInterval = 1500; // 40BPMä¸‹é™

            // ä¸Šæ˜‡æ¤œå‡ºï¼ˆé–¾å€¤ã‚’è¶…ãˆãŸï¼‰
            if (diff > threshold && !peakDetected && (now - lastPeakTime) > minInterval) {
                peakDetected = true;
                
                const interval = now - lastPeakTime;
                
                // æœ‰åŠ¹ãªé–“éš”ã®å ´åˆã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
                if (lastPeakTime > 0 && interval < maxInterval) {
                    
                    if (isDetecting) {
                        beatCount++;
                    }

                    // BPMè¨ˆç®—
                    const bpm = Math.round(60000 / interval);
                    if (bpm >= 40 && bpm <= 150) {
                        recentBPMs.push(bpm);
                        if (recentBPMs.length > 10) recentBPMs.shift();
                        
                        const avgBPM = Math.round(recentBPMs.reduce((a, b) => a + b, 0) / recentBPMs.length);
                        currentBPM = avgBPM;
                        
                        elements.bpmValue.textContent = avgBPM;
                        if (isDetecting) {
                            elements.bpmValue2.textContent = avgBPM;
                        }

                        // å®‰å®šæ¤œå‡º
                        stableDetectionCount++;
                        if (stableDetectionCount >= 3) {
                            elements.cameraContainer.classList.add('detecting');
                            elements.cameraLabel.textContent = 'å¿ƒæ‹æ¤œå‡ºä¸­ï¼æº–å‚™ãŒã§ããŸã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„';
                            elements.readyBtn.disabled = false;
                        }
                        
                        console.log('Beat detected! BPM:', bpm, 'Avg:', avgBPM);
                    }
                }
                
                lastPeakTime = now;

                // ãƒãƒ¼ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                elements.heartIcon.classList.add('beat');
                if (isDetecting) {
                    elements.heartIcon2.classList.add('beat');
                }
                setTimeout(() => {
                    elements.heartIcon.classList.remove('beat');
                    elements.heartIcon2.classList.remove('beat');
                }, 100);

                playHeartbeat();

            } else if (diff < threshold * 0.3) {
                // ä¸‹é™æ¤œå‡ºï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
                peakDetected = false;
            }
        }

        // æ¸¬å®šé–‹å§‹
        function startMeasurement() {
            showStep('step2');
            isDetecting = true;
            beatCount = 0;
            
            elements.timerValue.textContent = measurementDuration;
            
            let remaining = measurementDuration;
            
            playBeep(880, 0.3);
            
            measurementTimer = setInterval(() => {
                remaining--;
                elements.timerValue.textContent = remaining;
                
                if (remaining <= 0) {
                    endMeasurement();
                } else if (remaining <= 3) {
                    playBeep(660, 0.15);
                }
            }, 1000);
        }

        // æ¸¬å®šçµ‚äº†
        function endMeasurement() {
            clearInterval(measurementTimer);
            isDetecting = false;
            
            playBeep(440, 0.5);
            
            showStep('step3');
            elements.perceivedInput.value = '';
            setTimeout(() => {
                elements.perceivedInput.focus();
            }, 300);
        }

        // çµæœè¡¨ç¤º
        function showResults() {
            const perceived = parseInt(elements.perceivedInput.value) || 0;
            const actual = beatCount;
            const error = Math.abs(actual - perceived);
            
            // IAcã‚¹ã‚³ã‚¢è¨ˆç®—
            let iac = 0;
            if (actual > 0) {
                iac = Math.max(0, 1 - (error / actual));
            }

            // ãƒ©ãƒ³ã‚¯åˆ¤å®š
            let rank, rankClass, description;
            if (error <= 2) {
                rank = 'S';
                rankClass = 'rank-S';
                description = 'æ¥µã‚ã¦å„ªç§€ãªå†…å—å®¹è¦šã§ã™ï¼';
            } else if (error <= 5) {
                rank = 'A';
                rankClass = 'rank-A';
                description = 'å„ªç§€ãªå†…å—å®¹è¦šã§ã™ï¼';
            } else if (error <= 10) {
                rank = 'B';
                rankClass = 'rank-B';
                description = 'è‰¯å¥½ãªå†…å—å®¹è¦šã§ã™';
            } else if (error <= 15) {
                rank = 'C';
                rankClass = 'rank-C';
                description = 'å¹³å‡çš„ãªå†…å—å®¹è¦šã§ã™';
            } else {
                rank = 'D';
                rankClass = 'rank-D';
                description = 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§å‘ä¸Šã§ãã¾ã™';
            }

            // è¡¨ç¤ºæ›´æ–°
            elements.resultRank.textContent = rank;
            elements.resultRank.className = 'result-rank ' + rankClass;
            elements.resultDesc.textContent = description;
            elements.actualCount.textContent = actual + 'å›';
            elements.perceivedCount.textContent = perceived + 'å›';
            
            const diff = perceived - actual;
            elements.errorCount.textContent = (diff >= 0 ? '+' : '') + diff + 'å›';
            elements.iacScore.textContent = iac.toFixed(3);

            showStep('step4');
            playFanfare();
        }

        // ãƒªã‚»ãƒƒãƒˆ
        function resetTest() {
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            
            ppgData = [];
            recentBPMs = [];
            beatCount = 0;
            stableDetectionCount = 0;
            currentBPM = 0;
            baseline = 0;
            threshold = 0;
            peakDetected = false;
            lastPeakTime = 0;
            
            elements.cameraContainer.classList.remove('detecting');
            elements.bpmValue.textContent = '--';
            elements.readyBtn.disabled = true;
            
            initCamera();
        }

        // ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º
        function showStep(stepId) {
            elements.step1.classList.add('hidden');
            elements.step2.classList.add('hidden');
            elements.step3.classList.add('hidden');
            elements.step4.classList.add('hidden');
            elements.cameraError.classList.add('hidden');
            
            document.getElementById(stepId).classList.remove('hidden');
        }

        // éŸ³å£°
        function playBeep(freq, dur) {
            if (!audioContext) return;
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const now = audioContext.currentTime;
                
                osc.type = 'sine';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, now + dur);
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start(now);
                osc.stop(now + dur);
            } catch (e) {}
        }

        function playHeartbeat() {
            if (!audioContext) return;
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const now = audioContext.currentTime;
                
                osc.type = 'sine';
                osc.frequency.value = 80;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.1, now + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.12);
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start(now);
                osc.stop(now + 0.12);
            } catch (e) {}
        }

        async function playFanfare() {
            const notes = [
                { freq: 523, dur: 0.12 },
                { freq: 659, dur: 0.12 },
                { freq: 784, dur: 0.12 },
                { freq: 1047, dur: 0.3 }
            ];
            for (const note of notes) {
                playBeep(note.freq, note.dur);
                await new Promise(r => setTimeout(r, note.dur * 700));
            }
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW error:', err));
            });
        }

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        document.addEventListener('touchmove', (e) => {
            if (!e.target.closest('.side-menu-content') && !e.target.closest('.main-area')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
