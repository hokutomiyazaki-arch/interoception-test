<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PWAè¨­å®š -->
    <meta name="application-name" content="å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ">
    <meta name="apple-mobile-web-app-title" content="å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ">
    <link rel="manifest" href="manifest.json">
    
    <!-- ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
    <link rel="icon" href="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512.png">
    <link rel="apple-touch-icon" href="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512.png">
    
    <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ -->
    <meta name="theme-color" content="#e74c3c">
    
    <title>å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ - Interoceptive Awareness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            display: flex;
            flex-direction: column;
            padding: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .splash-screen.hide {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            width: 150px;
            height: 150px;
            margin-bottom: 30px;
        }

        .splash-brand {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 10px;
            font-weight: 500;
            text-align: center;
        }

        .splash-title {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        .splash-copyright {
            font-size: 0.8rem;
            color: #888;
            margin-top: 20px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            padding-top: max(15px, calc(env(safe-area-inset-top) + 10px));
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 40px;
            width: auto;
        }

        .header h1 {
            font-size: 1.2rem;
            background: linear-gradient(135deg, #e74c3c 0%, #f39c12 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.5rem;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #startScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        #startScreen .instruction-text {
            margin-bottom: 30px;
        }

        #startScreen .btn {
            font-size: 1.4rem;
            padding: 20px 50px;
        }

        /* ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ */
        .camera-container {
            position: relative;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #e74c3c;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
            margin-bottom: 20px;
        }

        .camera-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
        }

        .camera-overlay.hidden {
            display: none;
        }

        /* å¿ƒæ‹è¡¨ç¤º */
        .heartbeat-display {
            font-size: 4rem;
            font-weight: bold;
            color: #e74c3c;
            text-shadow: 0 0 30px rgba(231, 76, 60, 0.8);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .heart-icon {
            font-size: 3rem;
            animation: none;
        }

        .heart-icon.beating {
            animation: heartbeat 1s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            15% { transform: scale(1.3); }
            30% { transform: scale(1); }
        }

        .bpm-label {
            font-size: 1.2rem;
            color: #aaa;
            margin-bottom: 30px;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º */
        .timer-display {
            font-size: 5rem;
            font-weight: bold;
            color: #3498db;
            text-shadow: 0 0 30px rgba(52, 152, 219, 0.5);
            margin-bottom: 10px;
        }

        .timer-label {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 30px;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .status-text {
            font-size: 1.2rem;
            color: #f39c12;
            text-align: center;
            margin-bottom: 20px;
            min-height: 30px;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }

        .input-area.show {
            display: flex;
        }

        .input-area label {
            font-size: 1.1rem;
            color: #aaa;
        }

        .input-area input {
            width: 100%;
            padding: 15px;
            font-size: 2rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #3498db;
            border-radius: 15px;
            color: white;
            outline: none;
        }

        .input-area input:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.3);
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* çµæœè¡¨ç¤º */
        .results-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }

        .results-container.show {
            display: flex;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            text-align: center;
        }

        .result-card h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .result-score {
            font-size: 3rem;
            font-weight: bold;
            color: #2ecc71;
        }

        .result-interpretation {
            font-size: 1rem;
            color: #aaa;
            margin-top: 10px;
        }

        .trial-results {
            width: 100%;
        }

        .trial-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .trial-row:last-child {
            border-bottom: none;
        }

        /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .side-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            max-width: 80vw;
            height: 100%;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
        }

        .side-menu.open {
            right: 0;
        }

        .side-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .side-menu-header h2 {
            font-size: 1.3rem;
            color: #e74c3c;
        }

        .close-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
        }

        .side-menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
            touch-action: auto !important;
        }

        .side-menu-content * {
            touch-action: auto !important;
        }

        .menu-section {
            margin-bottom: 25px;
        }

        .menu-section h3 {
            color: #f39c12;
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-section p {
            color: #ccc;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .setting-group {
            margin-bottom: 15px;
        }

        .setting-group label {
            display: block;
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .setting-group select,
        .setting-group input[type="number"] {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .menu-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer {
            text-align: center;
            padding: 10px;
            font-size: 0.75rem;
            color: #666;
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        /* PPGæ³¢å½¢è¡¨ç¤º */
        .ppg-canvas-container {
            width: 100%;
            max-width: 350px;
            height: 80px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        #ppgCanvas {
            width: 100%;
            height: 100%;
        }

        /* é€²æ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .progress-dots {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .progress-dot.completed {
            background: #2ecc71;
        }

        .progress-dot.active {
            background: #e74c3c;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .countdown-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .countdown-number {
            font-size: 10rem;
            font-weight: bold;
            color: #e74c3c;
            text-shadow: 0 0 50px rgba(231, 76, 60, 0.8);
        }

        .countdown-text {
            font-size: 1.5rem;
            color: #aaa;
            margin-top: 20px;
        }

        /* ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤º */
        .phase-indicator {
            font-size: 1rem;
            color: #f39c12;
            margin-bottom: 10px;
        }

        /* æŒ‡ç¤ºãƒ†ã‚­ã‚¹ãƒˆ */
        .instruction-text {
            font-size: 1.1rem;
            color: #3498db;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-height: 600px) {
            .camera-container {
                width: 120px;
                height: 120px;
            }
            .heartbeat-display {
                font-size: 2.5rem;
            }
            .timer-display {
                font-size: 3rem;
            }
        }

        @media (max-width: 360px) {
            .header h1 {
                font-size: 1rem;
            }
            .btn {
                padding: 12px 25px;
                font-size: 1rem;
            }
        }

        /* PWAã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰ */
        @media all and (display-mode: standalone) {
            .header {
                padding-top: max(20px, calc(env(safe-area-inset-top) + 15px));
            }
        }

        /* iOSã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œ */
        @supports (padding-top: env(safe-area-inset-top)) {
            .header {
                padding-top: max(15px, calc(env(safe-area-inset-top) + 10px));
            }
        }

        /* éš ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #hiddenCanvas {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
    <div class="splash-screen" id="splashScreen">
        <img src="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512.png" alt="FNT Logo" class="splash-logo">
        <div class="splash-brand">Functional Neuro Training</div>
        <div class="splash-title">å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ</div>
        <div class="splash-copyright">Â© 2025 Functional Neuro Training</div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="main-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <div class="header-left">
                <img src="https://hokutomiyazaki-arch.github.io/interoception-test/FNT512-transparent.png" alt="FNT" class="logo">
                <h1>å†…å—å®¹è¦šãƒ†ã‚¹ãƒˆ</h1>
            </div>
            <button class="menu-btn" id="menuBtn">â˜°</button>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
        <main class="game-area" id="gameArea">
            <!-- åˆæœŸç”»é¢ -->
            <div id="startScreen" style="display: flex;">
                <div class="instruction-text">
                    ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®ã‚«ãƒ¡ãƒ©ã§å¿ƒæ‹ã‚’æ¸¬å®šã—ã€<br>
                    ã‚ãªãŸã®å†…å—å®¹æ„Ÿè¦šï¼ˆå¿ƒæ‹çŸ¥è¦šåŠ›ï¼‰ã‚’è©•ä¾¡ã—ã¾ã™ã€‚
                </div>
                <button class="btn btn-primary" id="startBtn">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹</button>
            </div>

            <!-- æ¸¬å®šç”»é¢ -->
            <div id="measurementScreen" style="display: none; flex-direction: column; align-items: center;">
                <div class="progress-dots" id="progressDots"></div>
                <div class="phase-indicator" id="phaseIndicator">è©¦è¡Œ 1 / 3</div>
                
                <div class="camera-container" id="cameraContainer">
                    <video id="cameraVideo" autoplay playsinline muted></video>
                    <div class="camera-overlay" id="cameraOverlay">
                        æŒ‡å…ˆã‚’ã‚«ãƒ¡ãƒ©ã«<br>è»½ãæŠ¼ã—å½“ã¦ã¦ãã ã•ã„
                    </div>
                </div>

                <div class="ppg-canvas-container">
                    <canvas id="ppgCanvas"></canvas>
                </div>

                <div class="heartbeat-display" id="heartbeatDisplay">
                    <span class="heart-icon" id="heartIcon">â¤ï¸</span>
                    <span id="bpmValue">--</span>
                </div>
                <div class="bpm-label">æ¸¬å®šä¸­ã®å¿ƒæ‹æ•° (BPM)</div>

                <div class="timer-display" id="timerDisplay">30</div>
                <div class="timer-label">æ®‹ã‚Šæ™‚é–“ï¼ˆç§’ï¼‰</div>

                <div class="status-text" id="statusText">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...</div>

                <div class="btn-group">
                    <button class="btn btn-secondary" id="calibrateBtn">ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                    <button class="btn btn-primary" id="startTrialBtn" disabled>æ¸¬å®šé–‹å§‹</button>
                </div>
            </div>

            <!-- å…¥åŠ›ç”»é¢ -->
            <div id="inputScreen" style="display: none; flex-direction: column; align-items: center;">
                <div class="phase-indicator" id="inputPhaseIndicator">è©¦è¡Œ 1 / 3 - çµæœå…¥åŠ›</div>
                
                <div class="instruction-text">
                    ä»Šã®æ¸¬å®šä¸­ã«æ„Ÿã˜ãŸå¿ƒæ‹ã®å›æ•°ã‚’<br>å…¥åŠ›ã—ã¦ãã ã•ã„
                </div>

                <div class="input-area show">
                    <label for="perceivedCount">æ„Ÿã˜ãŸå¿ƒæ‹æ•°ï¼š</label>
                    <input type="number" id="perceivedCount" min="0" max="200" placeholder="0">
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" id="submitCountBtn">æ¬¡ã¸é€²ã‚€</button>
                </div>
            </div>

            <!-- çµæœç”»é¢ -->
            <div id="resultsScreen" style="display: none; flex-direction: column; align-items: center;">
                <div class="results-container show">
                    <div class="result-card">
                        <h3>å¿ƒæ‹çŸ¥è¦šç²¾åº¦ã‚¹ã‚³ã‚¢ (IAc)</h3>
                        <div class="result-score" id="finalScore">0.00</div>
                        <div class="result-interpretation" id="scoreInterpretation">
                            è©•ä¾¡ã‚’è¨ˆç®—ä¸­...
                        </div>
                    </div>

                    <div class="result-card trial-results">
                        <h3>å„è©¦è¡Œã®çµæœ</h3>
                        <div id="trialResultsList"></div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="retryBtn">å†ãƒ†ã‚¹ãƒˆ</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="footer">
            Â© 2025 Functional Neuro Training. All rights reserved.
        </footer>
    </div>

    <!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h2>è¨­å®šãƒ»æƒ…å ±</h2>
            <button class="close-menu-btn" id="closeMenuBtn">âœ•</button>
        </div>
        <div class="side-menu-content">
            <div class="menu-section">
                <h3>ğŸ§  ç¥çµŒç§‘å­¦çš„èƒŒæ™¯</h3>
                <p>
                    å†…å—å®¹è¦šï¼ˆInteroceptionï¼‰ã¨ã¯ã€å¿ƒæ‹ã€å‘¼å¸ã€ç©ºè…¹æ„Ÿãªã©ä½“å†…ã®çŠ¶æ…‹ã‚’æ„ŸçŸ¥ã™ã‚‹èƒ½åŠ›ã§ã™ã€‚
                    å³¶çš®è³ªï¼ˆInsular Cortexï¼‰ãŒä¸­å¿ƒçš„å½¹å‰²ã‚’æ‹…ã„ã€æ„Ÿæƒ…èªè­˜ã‚„æ„æ€æ±ºå®šã«ã‚‚é–¢ä¸ã—ã¾ã™ã€‚
                </p>
                <p style="margin-top: 10px;">
                    <strong>Schandryæ³•</strong>ï¼ˆ1981å¹´ï¼‰ã¯ã€å®Ÿéš›ã®å¿ƒæ‹æ•°ã¨ä¸»è¦³çš„ã«æ•°ãˆãŸå¿ƒæ‹æ•°ã‚’æ¯”è¼ƒã—ã€
                    å¿ƒæ‹çŸ¥è¦šç²¾åº¦ï¼ˆIAcï¼‰ã‚’ç®—å‡ºã™ã‚‹æ¨™æº–çš„ãªè©•ä¾¡æ–¹æ³•ã§ã™ã€‚
                </p>
                <p style="margin-top: 10px;">
                    IAcã‚¹ã‚³ã‚¢ãŒé«˜ã„äººã¯ã€æ„Ÿæƒ…èª¿æ•´èƒ½åŠ›ã‚„èº«ä½“çš„è‡ªå·±èªè­˜ãŒå„ªã‚Œã¦ã„ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚
                </p>
            </div>

            <div class="menu-section">
                <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ‰‹é †</h3>
                <p>
                    1. åº§ä½ã§é™æ­¢ã—ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¾ã™<br>
                    2. æŒ‡å…ˆã‚’ã‚«ãƒ¡ãƒ©ã«å½“ã¦ã€å¿ƒæ‹ã‚’æ¸¬å®š<br>
                    3. ç›®ã‚’é–‰ã˜ã¦å¿ƒæ‹ã‚’æ•°ãˆã¾ã™ï¼ˆ30ç§’Ã—3å›ï¼‰<br>
                    4. æ„Ÿã˜ãŸå¿ƒæ‹æ•°ã‚’å…¥åŠ›<br>
                    5. IAcã‚¹ã‚³ã‚¢ã‚’ç®—å‡º
                </p>
            </div>

            <div class="menu-section">
                <h3>âš™ï¸ è¨­å®š</h3>
                <div class="setting-group">
                    <label>æ¸¬å®šæ™‚é–“ï¼ˆç§’ï¼‰</label>
                    <select id="trialDuration">
                        <option value="25">25ç§’</option>
                        <option value="30" selected>30ç§’</option>
                        <option value="35">35ç§’</option>
                        <option value="45">45ç§’</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>è©¦è¡Œå›æ•°</label>
                    <select id="trialCount">
                        <option value="2">2å›</option>
                        <option value="3" selected>3å›</option>
                        <option value="4">4å›</option>
                        <option value="5">5å›</option>
                    </select>
                </div>
            </div>

            <div class="menu-section">
                <h3>ğŸ“Š IAcã‚¹ã‚³ã‚¢ã®è§£é‡ˆ</h3>
                <p>
                    <strong>0.85ä»¥ä¸Š:</strong> éå¸¸ã«å„ªã‚ŒãŸå†…å—å®¹æ„Ÿè¦š<br>
                    <strong>0.70-0.84:</strong> è‰¯å¥½ãªå†…å—å®¹æ„Ÿè¦š<br>
                    <strong>0.50-0.69:</strong> å¹³å‡çš„ãªå†…å—å®¹æ„Ÿè¦š<br>
                    <strong>0.50æœªæº€:</strong> æ”¹å–„ã®ä½™åœ°ã‚ã‚Š
                </p>
            </div>

            <div class="menu-section">
                <h3>ğŸ“š å‚è€ƒæ–‡çŒ®</h3>
                <p style="font-size: 0.8rem;">
                    Schandry R. (1981). Heart beat perception and emotional experience. Psychophysiology, 18(4), 483-488.
                </p>
            </div>
        </div>
    </div>

    <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="countdown-overlay" id="countdownOverlay">
        <div class="countdown-number" id="countdownNumber">3</div>
        <div class="countdown-text" id="countdownText">ç›®ã‚’é–‰ã˜ã¦å¿ƒæ‹ã‚’æ•°ãˆã‚‹æº–å‚™ã‚’ã—ã¦ãã ã•ã„</div>
    </div>

    <!-- éš ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç”»åƒå‡¦ç†ç”¨ï¼‰ -->
    <canvas id="hiddenCanvas" width="100" height="100"></canvas>

    <script>
        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let audioContext = null;
        let videoStream = null;
        let isCalibrated = false;
        let isMeasuring = false;
        let currentTrial = 0;
        let trialDuration = 30;
        let totalTrials = 3;
        let trialResults = [];
        let currentTrialBPM = 0;
        let currentTrialBeats = 0;

        // PPGå‡¦ç†ç”¨
        let ppgData = [];
        let ppgCanvas, ppgCtx;
        let hiddenCanvas, hiddenCtx;
        let lastBeatTime = 0;
        let beatTimes = [];
        let measurementStartTime = 0;
        let measurementTimer = null;
        let ppgAnimationFrame = null;

        // ãƒ”ãƒ¼ã‚¯æ¤œå‡ºç”¨
        let baseline = 0;
        let threshold = 0;
        let peakDetected = false;
        let lastPeakTime = 0;
        let recentBPMs = [];

        // ========================================
        // DOMè¦ç´ 
        // ========================================
        const elements = {
            splashScreen: document.getElementById('splashScreen'),
            menuBtn: document.getElementById('menuBtn'),
            sideMenu: document.getElementById('sideMenu'),
            menuOverlay: document.getElementById('menuOverlay'),
            closeMenuBtn: document.getElementById('closeMenuBtn'),
            
            startScreen: document.getElementById('startScreen'),
            measurementScreen: document.getElementById('measurementScreen'),
            inputScreen: document.getElementById('inputScreen'),
            resultsScreen: document.getElementById('resultsScreen'),
            
            startBtn: document.getElementById('startBtn'),
            calibrateBtn: document.getElementById('calibrateBtn'),
            startTrialBtn: document.getElementById('startTrialBtn'),
            submitCountBtn: document.getElementById('submitCountBtn'),
            retryBtn: document.getElementById('retryBtn'),
            
            cameraVideo: document.getElementById('cameraVideo'),
            cameraOverlay: document.getElementById('cameraOverlay'),
            ppgCanvas: document.getElementById('ppgCanvas'),
            hiddenCanvas: document.getElementById('hiddenCanvas'),
            
            progressDots: document.getElementById('progressDots'),
            phaseIndicator: document.getElementById('phaseIndicator'),
            heartIcon: document.getElementById('heartIcon'),
            bpmValue: document.getElementById('bpmValue'),
            timerDisplay: document.getElementById('timerDisplay'),
            statusText: document.getElementById('statusText'),
            
            inputPhaseIndicator: document.getElementById('inputPhaseIndicator'),
            perceivedCount: document.getElementById('perceivedCount'),
            
            finalScore: document.getElementById('finalScore'),
            scoreInterpretation: document.getElementById('scoreInterpretation'),
            trialResultsList: document.getElementById('trialResultsList'),
            
            countdownOverlay: document.getElementById('countdownOverlay'),
            countdownNumber: document.getElementById('countdownNumber'),
            countdownText: document.getElementById('countdownText'),
            
            trialDurationSelect: document.getElementById('trialDuration'),
            trialCountSelect: document.getElementById('trialCount')
        };

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        function init() {
            // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
            setTimeout(() => {
                elements.splashScreen.classList.add('hide');
            }, 2500);

            // ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ–
            ppgCanvas = elements.ppgCanvas;
            ppgCtx = ppgCanvas.getContext('2d');
            hiddenCanvas = elements.hiddenCanvas;
            hiddenCtx = hiddenCanvas.getContext('2d');

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            elements.menuBtn.addEventListener('click', openMenu);
            elements.closeMenuBtn.addEventListener('click', closeMenu);
            elements.menuOverlay.addEventListener('click', closeMenu);
            
            elements.startBtn.addEventListener('click', startTest);
            elements.calibrateBtn.addEventListener('click', startCalibration);
            elements.startTrialBtn.addEventListener('click', startTrial);
            elements.submitCountBtn.addEventListener('click', submitCount);
            elements.retryBtn.addEventListener('click', retryTest);

            elements.trialDurationSelect.addEventListener('change', (e) => {
                trialDuration = parseInt(e.target.value);
            });

            elements.trialCountSelect.addEventListener('change', (e) => {
                totalTrials = parseInt(e.target.value);
            });

            // AudioContextåˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œï¼‰
            document.addEventListener('click', initAudio, { once: true });
            document.addEventListener('touchstart', initAudio, { once: true });
        }

        function resizeCanvas() {
            const container = ppgCanvas.parentElement;
            ppgCanvas.width = container.clientWidth;
            ppgCanvas.height = container.clientHeight;
        }

        async function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                // ãƒ€ãƒŸãƒ¼éŸ³ã§åˆæœŸåŒ–
                playBeep(1, 0.001);
            }
        }

        // ========================================
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        // ========================================
        function openMenu() {
            elements.sideMenu.classList.add('open');
            elements.menuOverlay.classList.add('show');
        }

        function closeMenu() {
            elements.sideMenu.classList.remove('open');
            elements.menuOverlay.classList.remove('show');
        }

        // ========================================
        // ãƒ†ã‚¹ãƒˆé–‹å§‹
        // ========================================
        async function startTest() {
            showScreen('measurement');
            await startCamera();
            updateProgressDots();
        }

        // ========================================
        // ã‚«ãƒ¡ãƒ©
        // ========================================
        async function startCamera() {
            try {
                elements.statusText.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...';

                // åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ã‚’å–å¾—
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                
                // èƒŒé¢ã‚«ãƒ¡ãƒ©ã®ä¸­ã‹ã‚‰æ¨™æº–ï¼ˆåºƒè§’ï¼‰ãƒ¬ãƒ³ã‚ºã‚’é¸æŠ
                // æœ›é ãƒ¬ãƒ³ã‚ºã‚’é¿ã‘ã‚‹ãŸã‚ã€æœ€åˆã®èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨
                let selectedDeviceId = null;
                
                for (const device of videoDevices) {
                    const label = device.label.toLowerCase();
                    // æœ›é ã€telephotoã€zoomã€2xãªã©ã‚’é¿ã‘ã‚‹
                    if (!label.includes('front') && 
                        !label.includes('telephoto') && 
                        !label.includes('tele') &&
                        !label.includes('zoom') &&
                        !label.includes('2x') &&
                        !label.includes('3x') &&
                        !label.includes('5x')) {
                        // åºƒè§’ã¾ãŸã¯ãƒ¡ã‚¤ãƒ³/æ¨™æº–ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
                        if (label.includes('wide') || label.includes('main') || 
                            label.includes('back') || label.includes('rear') ||
                            label.includes('0') || !selectedDeviceId) {
                            selectedDeviceId = device.deviceId;
                            console.log('Selected camera:', device.label);
                        }
                    }
                }

                // ã‚«ãƒ¡ãƒ©ã®è¨­å®š
                const constraints = {
                    video: {
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 },
                        frameRate: { ideal: 30 }
                    }
                };

                // ãƒ‡ãƒã‚¤ã‚¹IDãŒå–å¾—ã§ããŸå ´åˆã¯æŒ‡å®š
                if (selectedDeviceId) {
                    constraints.video.deviceId = { exact: selectedDeviceId };
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç’°å¢ƒã‚«ãƒ¡ãƒ©ã‚’æŒ‡å®šï¼ˆãŸã ã—exactã§ã¯ãªã„ï¼‰
                    constraints.video.facingMode = 'environment';
                }

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                elements.cameraVideo.srcObject = videoStream;
                
                await elements.cameraVideo.play();

                // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚ªãƒ³ã«ã™ã‚‹è©¦è¡Œï¼ˆPPGæ¸¬å®šç²¾åº¦å‘ä¸Šã®ãŸã‚ï¼‰
                const track = videoStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if (capabilities.torch) {
                    try {
                        await track.applyConstraints({
                            advanced: [{ torch: true }]
                        });
                        console.log('Torch enabled');
                    } catch (e) {
                        console.log('Could not enable torch:', e);
                    }
                }

                elements.statusText.textContent = 'æŒ‡å…ˆã‚’ã‚«ãƒ¡ãƒ©ã«è»½ãæŠ¼ã—å½“ã¦ã¦ãã ã•ã„';
                elements.calibrateBtn.disabled = false;

            } catch (error) {
                console.error('Camera error:', error);
                elements.statusText.textContent = 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
            }
        }

        // ========================================
        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        // ========================================
        async function startCalibration() {
            elements.statusText.textContent = 'ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­... 5ç§’é–“å‹•ã‹ãªã„ã§ãã ã•ã„';
            elements.calibrateBtn.disabled = true;
            elements.startTrialBtn.disabled = true;

            ppgData = [];
            let calibrationData = [];
            let frames = 0;
            const calibrationDuration = 5000;
            const startTime = Date.now();

            // PPGè§£æé–‹å§‹
            function analyzeFrame() {
                if (Date.now() - startTime < calibrationDuration) {
                    const value = getPPGValue();
                    if (value !== null) {
                        calibrationData.push(value);
                    }
                    ppgAnimationFrame = requestAnimationFrame(analyzeFrame);
                } else {
                    finishCalibration(calibrationData);
                }
            }

            analyzeFrame();
        }

        function finishCalibration(data) {
            if (data.length < 50) {
                elements.statusText.textContent = 'ä¿¡å·ãŒå¼±ã„ã§ã™ã€‚æŒ‡ã‚’ã‚«ãƒ¡ãƒ©ã«ã—ã£ã‹ã‚Šå½“ã¦ã¦ãã ã•ã„';
                elements.calibrateBtn.disabled = false;
                return;
            }

            // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨é–¾å€¤ã‚’è¨ˆç®—
            const sum = data.reduce((a, b) => a + b, 0);
            baseline = sum / data.length;
            
            const variance = data.reduce((acc, val) => acc + Math.pow(val - baseline, 2), 0) / data.length;
            const stdDev = Math.sqrt(variance);
            threshold = stdDev * 0.6;

            isCalibrated = true;
            elements.statusText.textContent = 'ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ï¼ã€Œæ¸¬å®šé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„';
            elements.cameraOverlay.classList.add('hidden');
            elements.calibrateBtn.disabled = false;
            elements.startTrialBtn.disabled = false;

            // PPGæ³¢å½¢ã®æç”»ã‚’é–‹å§‹
            startPPGVisualization();

            playBeep(800, 0.2);
        }

        // ========================================
        // PPGå€¤å–å¾—
        // ========================================
        function getPPGValue() {
            try {
                hiddenCtx.drawImage(elements.cameraVideo, 0, 0, 100, 100);
                const imageData = hiddenCtx.getImageData(30, 30, 40, 40);
                const data = imageData.data;

                let redSum = 0;
                let count = 0;

                for (let i = 0; i < data.length; i += 4) {
                    redSum += data[i]; // Red channel
                    count++;
                }

                return redSum / count;
            } catch (e) {
                return null;
            }
        }

        // ========================================
        // PPGæ³¢å½¢å¯è¦–åŒ–
        // ========================================
        function startPPGVisualization() {
            function drawPPG() {
                const value = getPPGValue();
                if (value !== null) {
                    ppgData.push(value);
                    if (ppgData.length > ppgCanvas.width) {
                        ppgData.shift();
                    }

                    // ãƒ”ãƒ¼ã‚¯æ¤œå‡º
                    detectPeak(value);

                    // æç”»
                    drawPPGWaveform();
                }

                if (isCalibrated) {
                    ppgAnimationFrame = requestAnimationFrame(drawPPG);
                }
            }

            drawPPG();
        }

        function drawPPGWaveform() {
            const width = ppgCanvas.width;
            const height = ppgCanvas.height;

            ppgCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ppgCtx.fillRect(0, 0, width, height);

            if (ppgData.length < 2) return;

            // ãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ–
            const min = Math.min(...ppgData);
            const max = Math.max(...ppgData);
            const range = max - min || 1;

            ppgCtx.beginPath();
            ppgCtx.strokeStyle = '#e74c3c';
            ppgCtx.lineWidth = 2;

            for (let i = 0; i < ppgData.length; i++) {
                const x = (i / ppgData.length) * width;
                const normalizedValue = (ppgData[i] - min) / range;
                const y = height - (normalizedValue * height * 0.8 + height * 0.1);

                if (i === 0) {
                    ppgCtx.moveTo(x, y);
                } else {
                    ppgCtx.lineTo(x, y);
                }
            }

            ppgCtx.stroke();
        }

        // ========================================
        // ãƒ”ãƒ¼ã‚¯æ¤œå‡ºï¼ˆå¿ƒæ‹æ¤œå‡ºï¼‰
        // ========================================
        function detectPeak(value) {
            const now = Date.now();
            const deviation = value - baseline;

            // æœ€å°é–“éš”ï¼ˆ300ms = 200BPMä¸Šé™ï¼‰
            const minInterval = 300;

            if (deviation > threshold && !peakDetected && (now - lastPeakTime) > minInterval) {
                peakDetected = true;
                lastPeakTime = now;

                if (isMeasuring) {
                    beatTimes.push(now);
                    currentTrialBeats++;
                }

                // BPMè¨ˆç®—
                if (beatTimes.length >= 2) {
                    const recentBeats = beatTimes.slice(-5);
                    let totalInterval = 0;
                    for (let i = 1; i < recentBeats.length; i++) {
                        totalInterval += recentBeats[i] - recentBeats[i - 1];
                    }
                    const avgInterval = totalInterval / (recentBeats.length - 1);
                    const bpm = Math.round(60000 / avgInterval);

                    if (bpm >= 40 && bpm <= 200) {
                        recentBPMs.push(bpm);
                        if (recentBPMs.length > 5) recentBPMs.shift();
                        
                        const avgBPM = Math.round(recentBPMs.reduce((a, b) => a + b, 0) / recentBPMs.length);
                        currentTrialBPM = avgBPM;
                        elements.bpmValue.textContent = avgBPM;
                    }
                }

                // ãƒãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                elements.heartIcon.classList.add('beating');
                setTimeout(() => {
                    elements.heartIcon.classList.remove('beating');
                }, 200);

                playHeartbeat();

            } else if (deviation < threshold * 0.3) {
                peakDetected = false;
            }
        }

        // ========================================
        // è©¦è¡Œé–‹å§‹
        // ========================================
        async function startTrial() {
            elements.startTrialBtn.disabled = true;
            elements.calibrateBtn.disabled = true;

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
            await showCountdown();

            // æ¸¬å®šé–‹å§‹
            isMeasuring = true;
            beatTimes = [];
            currentTrialBeats = 0;
            measurementStartTime = Date.now();

            elements.statusText.textContent = 'ç›®ã‚’é–‰ã˜ã¦å¿ƒæ‹ã‚’æ•°ãˆã¦ãã ã•ã„';
            elements.timerDisplay.textContent = trialDuration;

            // ã‚¿ã‚¤ãƒãƒ¼
            measurementTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - measurementStartTime) / 1000);
                const remaining = trialDuration - elapsed;
                
                if (remaining <= 0) {
                    endTrial();
                } else {
                    elements.timerDisplay.textContent = remaining;
                }
            }, 100);
        }

        async function showCountdown() {
            return new Promise((resolve) => {
                elements.countdownOverlay.classList.add('show');
                let count = 3;
                elements.countdownNumber.textContent = count;

                const interval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        elements.countdownNumber.textContent = count;
                        playBeep(660, 0.15);
                    } else {
                        clearInterval(interval);
                        playBeep(880, 0.3);
                        elements.countdownOverlay.classList.remove('show');
                        resolve();
                    }
                }, 1000);

                playBeep(440, 0.15);
            });
        }

        // ========================================
        // è©¦è¡Œçµ‚äº†
        // ========================================
        function endTrial() {
            clearInterval(measurementTimer);
            isMeasuring = false;

            // å®Ÿéš›ã®å¿ƒæ‹æ•°ã‚’è¨ˆç®—
            const actualBeats = beatTimes.length;
            
            // çµæœã‚’ä¸€æ™‚ä¿å­˜
            trialResults.push({
                trialNumber: currentTrial + 1,
                actualBeats: actualBeats,
                measuredBPM: currentTrialBPM,
                perceivedBeats: 0 // å¾Œã§å…¥åŠ›
            });

            playBeep(600, 0.5);

            // å…¥åŠ›ç”»é¢ã¸
            showInputScreen();
        }

        function showInputScreen() {
            showScreen('input');
            elements.inputPhaseIndicator.textContent = `è©¦è¡Œ ${currentTrial + 1} / ${totalTrials} - çµæœå…¥åŠ›`;
            elements.perceivedCount.value = '';
            elements.perceivedCount.focus();
        }

        // ========================================
        // ã‚«ã‚¦ãƒ³ãƒˆå…¥åŠ›
        // ========================================
        function submitCount() {
            const perceived = parseInt(elements.perceivedCount.value) || 0;
            
            if (perceived < 0) {
                alert('0ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // çµæœã‚’æ›´æ–°
            trialResults[currentTrial].perceivedBeats = perceived;

            currentTrial++;
            updateProgressDots();

            if (currentTrial >= totalTrials) {
                // å…¨è©¦è¡Œå®Œäº†
                showResults();
            } else {
                // æ¬¡ã®è©¦è¡Œã¸
                showScreen('measurement');
                elements.phaseIndicator.textContent = `è©¦è¡Œ ${currentTrial + 1} / ${totalTrials}`;
                elements.statusText.textContent = 'ã€Œæ¸¬å®šé–‹å§‹ã€ã‚’æŠ¼ã—ã¦æ¬¡ã®è©¦è¡Œã‚’é–‹å§‹';
                elements.startTrialBtn.disabled = false;
                elements.calibrateBtn.disabled = false;
            }
        }

        // ========================================
        // çµæœè¡¨ç¤º
        // ========================================
        function showResults() {
            stopCamera();
            showScreen('results');

            // IAcã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆSchandryæ³•ï¼‰
            let scoreSum = 0;
            let trialListHTML = '';

            for (const trial of trialResults) {
                const actual = trial.actualBeats;
                const perceived = trial.perceivedBeats;
                
                let trialScore = 0;
                if (actual > 0) {
                    trialScore = 1 - (Math.abs(actual - perceived) / actual);
                    trialScore = Math.max(0, trialScore); // è² ã®å€¤ã¯0ã«
                }
                scoreSum += trialScore;

                trialListHTML += `
                    <div class="trial-row">
                        <span>è©¦è¡Œ ${trial.trialNumber}</span>
                        <span>å®Ÿæ¸¬: ${actual}å›</span>
                        <span>ç”³å‘Š: ${perceived}å›</span>
                        <span>ç²¾åº¦: ${(trialScore * 100).toFixed(1)}%</span>
                    </div>
                `;
            }

            const iacScore = scoreSum / trialResults.length;
            elements.finalScore.textContent = iacScore.toFixed(3);
            elements.trialResultsList.innerHTML = trialListHTML;

            // è§£é‡ˆ
            let interpretation = '';
            if (iacScore >= 0.85) {
                interpretation = 'ğŸŒŸ éå¸¸ã«å„ªã‚ŒãŸå†…å—å®¹æ„Ÿè¦šã§ã™ï¼èº«ä½“ã‹ã‚‰ã®ä¿¡å·ã‚’æ­£ç¢ºã«æ„ŸçŸ¥ã§ãã¦ã„ã¾ã™ã€‚';
                elements.finalScore.style.color = '#2ecc71';
            } else if (iacScore >= 0.70) {
                interpretation = 'ğŸ‘ è‰¯å¥½ãªå†…å—å®¹æ„Ÿè¦šã§ã™ã€‚èº«ä½“ã¸ã®æ°—ã¥ããŒé«˜ã„ãƒ¬ãƒ™ãƒ«ã«ã‚ã‚Šã¾ã™ã€‚';
                elements.finalScore.style.color = '#3498db';
            } else if (iacScore >= 0.50) {
                interpretation = 'ğŸ“Š å¹³å‡çš„ãªå†…å—å®¹æ„Ÿè¦šã§ã™ã€‚ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç·´ç¿’ã§å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚';
                elements.finalScore.style.color = '#f39c12';
            } else {
                interpretation = 'ğŸ’¡ å†…å—å®¹æ„Ÿè¦šã®å‘ä¸Šä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚ç‘æƒ³ã‚„ãƒœãƒ‡ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒãŠã™ã™ã‚ã§ã™ã€‚';
                elements.finalScore.style.color = '#e74c3c';
            }

            elements.scoreInterpretation.textContent = interpretation;

            playFanfare();
        }

        // ========================================
        // å†ãƒ†ã‚¹ãƒˆ
        // ========================================
        async function retryTest() {
            currentTrial = 0;
            trialResults = [];
            isCalibrated = false;
            currentTrialBPM = 0;
            currentTrialBeats = 0;
            ppgData = [];
            beatTimes = [];
            recentBPMs = [];

            elements.bpmValue.textContent = '--';
            elements.timerDisplay.textContent = trialDuration;
            elements.cameraOverlay.classList.remove('hidden');
            elements.startTrialBtn.disabled = true;

            showScreen('measurement');
            await startCamera();
            updateProgressDots();
        }

        // ========================================
        // ã‚«ãƒ¡ãƒ©åœæ­¢
        // ========================================
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (ppgAnimationFrame) {
                cancelAnimationFrame(ppgAnimationFrame);
            }
            isCalibrated = false;
        }

        // ========================================
        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        function showScreen(screenName) {
            elements.startScreen.style.display = 'none';
            elements.measurementScreen.style.display = 'none';
            elements.inputScreen.style.display = 'none';
            elements.resultsScreen.style.display = 'none';

            switch (screenName) {
                case 'start':
                    elements.startScreen.style.display = 'flex';
                    break;
                case 'measurement':
                    elements.measurementScreen.style.display = 'flex';
                    break;
                case 'input':
                    elements.inputScreen.style.display = 'flex';
                    break;
                case 'results':
                    elements.resultsScreen.style.display = 'flex';
                    break;
            }
        }

        // ========================================
        // é€²æ—ãƒ‰ãƒƒãƒˆæ›´æ–°
        // ========================================
        function updateProgressDots() {
            let dotsHTML = '';
            for (let i = 0; i < totalTrials; i++) {
                let className = 'progress-dot';
                if (i < currentTrial) {
                    className += ' completed';
                } else if (i === currentTrial) {
                    className += ' active';
                }
                dotsHTML += `<div class="${className}"></div>`;
            }
            elements.progressDots.innerHTML = dotsHTML;
            elements.phaseIndicator.textContent = `è©¦è¡Œ ${currentTrial + 1} / ${totalTrials}`;
        }

        // ========================================
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª
        // ========================================
        function playBeep(frequency, duration) {
            if (!audioContext) return;

            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const now = audioContext.currentTime;

                osc.type = 'sine';
                osc.frequency.value = frequency;

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, now + duration);

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.start(now);
                osc.stop(now + duration);
            } catch (e) {
                console.error('Audio error:', e);
            }
        }

        function playHeartbeat() {
            if (!audioContext) return;

            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const now = audioContext.currentTime;

                osc.type = 'sine';
                osc.frequency.value = 80;

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.15, now + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.start(now);
                osc.stop(now + 0.15);
            } catch (e) {}
        }

        async function playFanfare() {
            const notes = [
                { freq: 523, dur: 0.15 },
                { freq: 659, dur: 0.15 },
                { freq: 784, dur: 0.15 },
                { freq: 1047, dur: 0.4 }
            ];

            for (const note of notes) {
                playBeep(note.freq, note.dur);
                await new Promise(r => setTimeout(r, note.dur * 800));
            }
        }

        // ========================================
        // åˆæœŸåŒ–å®Ÿè¡Œ
        // ========================================
        init();

        // ========================================
        // Service Workerç™»éŒ²
        // ========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }

        // ========================================
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        // ========================================
        document.addEventListener('touchmove', (e) => {
            if (!e.target.closest('.side-menu-content')) {
                e.preventDefault();
            }
        }, { passive: false });

        window.addEventListener('scroll', () => {
            window.scrollTo(0, 0);
        });
    </script>
</body>
</html>
